# Railsのデザインパターン
- [Railsのデザインパターンまとめ](https://applis.io/posts/rails-design-patterns)

## 1. Railsにおけるデザインパターンとは  
モデルやコントローラ、ビューに頻出する実装パターンを、  
オブジェクト設計の原則にもとづいて抽象化したパターンのこと  
  
デザインパターンに従う => 設計上の問題を防ぐことが可能

---
## 2. なぜデザインパターンが必要か  
アプリケーションが大きくなるにしたがって起こりがちな設計上の問題を防ぐために必要  
  
### 2.1 代表的な問題
- Fat Model
- Fat Controller
- Fat View
  
RailsのデフォルトのMVCだけにコードを記述していくとコードが肥大化してしまう  
=> オブジェクト指向設計の原則を守るのは難しい  
  
### 2.2 デメリット
- 拡張性や再利用性がなくなる
- テストも書きづらい  
=> オブジェクト指向設計の原則に基づいてクラスを分割していく必要がある

### 2.3 デザインパターン
クラス分割 => 頻出パターンを抽象化 => 「デザインパターン」

---
## 3. デザインパターンを導入するときの前提  
### 3.1 オブジェクト指向設計の原則  
オブジェクト指向設計の原則を忠実に守る必要がある  
  
SOLIDの原則  
- 単一責任の原則(Single Responsibility Principle)
- オープン・クローズドの原則(Open-Closed Principle)
- リスコフの置換原則(Liskov Substitution Principle)
- インターフェイス分離の原則(Interface Segregation Principle)
- 依存性逆転の原則(Dependency Inversion Principle)
  
### 3.2 プログラミング作業  
プログラミング作業の流れ
1. 原則を守りつつ、まずはRailsが用意したモデルやコントローラ、ビューのレイヤーにコードを書く
2. パターンが現れたときに適切なデザインパターンの導入を検討
    - デザインパターンの導入ありきならないように注意
    - オブジェクト指向設計の原則と向き合う

---
## 4. Railsのデザインパターン一覧
- Decoratorオブジェクト
- Deliveryオブジェクト
- Formオブジェクト
- Interactorオブジェクト
- Policyオブジェクト
- Queryオブジェクト
- Validatorオブジェクト
- Valueオブジェクト
- View Componentオブジェクト
  
### 4.1 Decoratorオブジェクト  
モデルに対するビューのロジックをカプセル化する責務を持つ  
- ビューにはモデルに関連するロジックがよく登場する
  - ビューからモデルにアクセスする
    - 肥大化の原因
    - 再利用性がなくなる
    - テストが書きづらい

=> Decoratorオブジェクト
- ディレクトリ：`app/decorators`

### 4.2 Deliveryオブジェクト  
通知に関するロジックをカプセル化する責務を持つ
- Railsデフォルト：ActionMailer
- メール以外にもSlackやLINEなどのチャットツールに通知することもある
  - 通知に関する処理をラップする => Deliveryオブジェクト

- ディレクトリ：`app/deliveries`

### 4.3 Formオブジェクト
ユーザからの入力を整形・検証して永続化する責務を持つ
- ユーザからの入力を処理するのはコントローラの役割
  - 複雑な処理
  - 複数の場所で行われる処理
    - コードの肥大化

=> Formオブジェクト
- ディレクトリ：`app/forms`

### 4.4 Interactorオブジェクト  
ビジネスロジックをカプセル化する責務を持つ  
- アプリケーションの一つのみのビジネスロジックを持つ
  - 再利用性がある
  - テストが書きやすい
- ディレクトリ：`app/interactors`

- Serviceオブジェクトとの違い
  - 定義があいまいで、オブジェクト指向設計の原則が守られづらい

### 4.5 Policyオブジェクト  
ビジネスルールをカプセル化する責務を持つ
- 例：ユーザの役割に応じて処理を実行する権限をもつかどうかを判断
  - コントローラやビューがルールに関するロジックで肥大
- ディレクトリ：`app/policies`

### 4.6 Queryオブジェクト  
ActiveRecord::Relationに対して結合や絞り込み、ソートなどの操作を行い、Relationを返す責務を持つ
- Relationに対する複雑な操作や再利用性のある操作を分割する
  - 再利用が可能
- ActiveRecord::Base継承クラスのスコープ経由で呼び出す
  - 依存関係が明確
  - 返却されるクラスも自明になる
- ディレクトリ：`app/queries`

### 4.7 Validatorオブジェクト  
ActiveRecord::Base継承クラスのレコードを検証する責務を持つ
- 複数の場所で利用される検証ロジックを書く
  - 再利用が可能
- ディレクトリ：`app/validators`

### 4.8 Valueオブジェクト  
値オブジェクトをカプセル化する責務を持つ
- 例：住所、メールアドレス、商品のレビューにおける星の数といった値オブジェクトを書く
  - 再利用が可能
- ディレクトリ：`app/values`

### 4.9 View Componentオブジェクト  
ビューをコンポーネント単位でカプセル化する責務を持つ
- 再利用性のあるビューを、ビジネスロジックごとカプセル化する
  - 再利用が可能
- ディレクトリ：`app/view_components`